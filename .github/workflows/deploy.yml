name: Build, Push, Deploy (ACA)

on:
  push:
    branches: ["main"]

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      RG: rg-azure-assistant
      LOCATION: westeurope

      ACR_NAME: acrassistantdemo
      IMAGE_NAME: azure-assistant

      ACA_ENV: env-azure-assistant
      ACA_APP: azure-ai-knowledge-assistant
      TARGET_PORT: 8501

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure login (SP via AZURE_CREDENTIALS)
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Derive image tag
        shell: bash
        run: |
          echo "IMAGE_TAG=${GITHUB_SHA::7}" >> $GITHUB_ENV
          echo "LOGIN_SERVER=${{ env.ACR_NAME }}.azurecr.io" >> $GITHUB_ENV

      # Robust ACR login for Docker push
      - name: Docker login to ACR (token-based)
        shell: bash
        run: |
          TOKEN=$(az acr login -n "${{ env.ACR_NAME }}" --expose-token --query accessToken -o tsv)
          docker login "${{ env.LOGIN_SERVER }}" \
            -u 00000000-0000-0000-0000-000000000000 \
            -p "$TOKEN"

      - name: Build image
        run: |
          docker build -t ${{ env.LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} .

      - name: Push image
        run: |
          docker push ${{ env.LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}

      - name: Ensure Container Apps Environment
        shell: bash
        run: |
          az containerapp env show \
            --name "${{ env.ACA_ENV }}" \
            --resource-group "${{ env.RG }}" 1>/dev/null 2>/dev/null \
          && echo "env exists" \
          || az containerapp env create \
            --name "${{ env.ACA_ENV }}" \
            --resource-group "${{ env.RG }}" \
            --location "${{ env.LOCATION }}"

      # OPTION A (reliable): use ACR admin creds for pull
      - name: Deploy (create or update) - Registry via ACR admin creds
        shell: bash
        run: |
          REG_USER=$(az acr credential show -n "${{ env.ACR_NAME }}" --query username -o tsv)
          REG_PASS=$(az acr credential show -n "${{ env.ACR_NAME }}" --query passwords[0].value -o tsv)

          if az containerapp show --name "${{ env.ACA_APP }}" --resource-group "${{ env.RG }}" 1>/dev/null 2>/dev/null; then
            az containerapp update \
              --name "${{ env.ACA_APP }}" \
              --resource-group "${{ env.RG }}" \
              --image "${{ env.LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}" \
              --set-env-vars OPENAI_API_KEY="${{ secrets.OPENAI_API_KEY }}" \
              --registry-server "${{ env.LOGIN_SERVER }}" \
              --registry-username "$REG_USER" \
              --registry-password "$REG_PASS"
          else
            az containerapp create \
              --name "${{ env.ACA_APP }}" \
              --resource-group "${{ env.RG }}" \
              --environment "${{ env.ACA_ENV }}" \
              --image "${{ env.LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}" \
              --ingress external \
              --target-port "${{ env.TARGET_PORT }}" \
              --set-env-vars OPENAI_API_KEY="${{ secrets.OPENAI_API_KEY }}" \
              --registry-server "${{ env.LOGIN_SERVER }}" \
              --registry-username "$REG_USER" \
              --registry-password "$REG_PASS"
          fi