name: Build, Push and Deploy to Azure Container Apps

on:
  push:
    branches: ["main"]

permissions:
  contents: read

jobs:
  build-deploy:
    runs-on: ubuntu-latest

    env:
      RG: rg-azure-assistant
      LOCATION: westeurope

      ACR_NAME: acrassistantdemo
      IMAGE_NAME: azure-assistant

      ACA_ENV: env-azure-assistant
      ACA_APP: azure-ai-knowledge-assistant
      TARGET_PORT: 8501

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Derive image tag
        shell: bash
        run: |
          echo "IMAGE_TAG=${GITHUB_SHA::7}" >> $GITHUB_ENV

      # Docker auth to ACR using GitHub Secrets (stable)
      - name: Docker login to ACR
        shell: bash
        run: |
          docker login "${{ secrets.ACR_LOGIN_SERVER }}" \
            -u "${{ secrets.ACR_USERNAME }}" \
            -p "${{ secrets.ACR_PASSWORD }}"

      - name: Docker build
        run: |
          docker build -t ${{ secrets.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} .

      - name: Docker push
        run: |
          docker push ${{ secrets.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}

      - name: Ensure Container Apps Environment
        shell: bash
        run: |
          az containerapp env show \
            --name "${{ env.ACA_ENV }}" \
            --resource-group "${{ env.RG }}" 1>/dev/null 2>/dev/null \
          && echo "env exists" \
          || az containerapp env create \
            --name "${{ env.ACA_ENV }}" \
            --resource-group "${{ env.RG }}" \
            --location "${{ env.LOCATION }}"

      # Set registry credentials for the Container App (idempotent)
      - name: Set Container App registry credentials
        shell: bash
        run: |
          az containerapp registry set \
            --name "${{ env.ACA_APP }}" \
            --resource-group "${{ env.RG }}" \
            --server "${{ secrets.ACR_LOGIN_SERVER }}" \
            --username "${{ secrets.ACR_USERNAME }}" \
            --password "${{ secrets.ACR_PASSWORD }}" \
          || true

      - name: Deploy Container App (create or update)
        shell: bash
        run: |
          IMG="${{ secrets.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}"

          if az containerapp show --name "${{ env.ACA_APP }}" --resource-group "${{ env.RG }}" 1>/dev/null 2>/dev/null; then
            az containerapp update \
              --name "${{ env.ACA_APP }}" \
              --resource-group "${{ env.RG }}" \
              --image "$IMG" \
              --target-port "${{ env.TARGET_PORT }}" \
              --set-env-vars OPENAI_API_KEY="${{ secrets.OPENAI_API_KEY }}"
          else
            az containerapp create \
              --name "${{ env.ACA_APP }}" \
              --resource-group "${{ env.RG }}" \
              --environment "${{ env.ACA_ENV }}" \
              --image "$IMG" \
              --ingress external \
              --target-port "${{ env.TARGET_PORT }}" \
              --set-env-vars OPENAI_API_KEY="${{ secrets.OPENAI_API_KEY }}"
          fi